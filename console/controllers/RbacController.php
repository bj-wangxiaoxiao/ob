<?php

namespace console\controllers;

use backend\config\AuthConfig;
use backend\models\AuthAssignment;
use backend\models\AuthItem;
use Yii;
use yii\base\Exception;
use yii\console\Controller;
use yii\rbac\Item;
use yii\rbac\ManagerInterface;

class RbacController extends Controller
{
	private $auth;
	private $handle;
	private $msg;
	private $role;
	
	public function init()
	{
		$this->auth = AuthConfig::getAuth();
		$this->handle = AuthConfig::getHandle();
		$this->role = AuthConfig::getRole();
		parent::init(); // TODO: Change the autogenerated stub
	}
	
	/**
	 * 初始化权限和角色，如果系统无超管，则会把id最小的admin_user设置为超管
	 * 添加完权限后，需要运行此接口
	 * @throws \Exception
	 */
	public function actionInit()
	{
		$assigments = AuthAssignment::find()->asArray()->all();
		$amg = Yii::$app->authManager;
		$this->_addPermission($amg);
		$this->_addRole($amg);
		//如果assignment已经有数据了，则不初始化管理员信息了
		//以上两个方法会清空assignment里的数据，所以此处需要把数据先查出来，等清空后再存进去
		if(empty($assigments)){
			$this->_addAssignment($amg);
		}
//		else{
//			foreach ($assigments as $assigment) {
//				$model = new AuthAssignment();
//				$form['AuthAssignment'] = $assigment;
//				$model->load($form);
//				$model->save();
//			}
//		}
	}
	
	private function _addPermission(ManagerInterface $amg)
	{
		//1、清空所有的权限
//		AuthItem::deleteAll(['type' => Item::TYPE_PERMISSION]);
		//循环配置文件，逐一添加需要的权限
		$succ = 0;
		foreach ($this->auth as $auth => $item) {
			$auth_desc = $item['desc'];
			$this->handle = array_merge($this->handle,$item['extraHandle']);
			foreach ($this->handle as $handle => $desc) {
				$auth_handle = $auth . '/' . $handle;
				$one = AuthItem::findOne(['name'=>$auth_handle]);
				if($one){
					continue;
				}
				$p = $amg->createPermission($auth_handle);
				$p->description = $auth_desc . $desc;
				$amg->add($p);
				$this->msg = "add permission [{$auth_handle}] success !";
				$succ++;
				$this->outputInfo();
			}
		}
		$this->msg = "add permission success count : [{$succ}]";
		$this->outputInfo();
	}
	
	private function _addRole(ManagerInterface $amg)
	{
		$succ = 0;
		//1、清空所有的角色
//		AuthItem::deleteAll(['type' => Item::TYPE_ROLE]);
		//循环配置文件，逐一添加需要的角色
		foreach ($this->role as $name => $info) {
			$desc = $info['desc'];
			$parent = $info['parent'];
			$role = $amg->createRole($name);
			$role->description = $desc;
			try {
				$amg->add($role);
				$this->msg = "add role [{$name}] success !";
				$this->outputInfo();
			} catch (\Exception $e) {
				$this->msg = "{$name} has been added";
				$this->outputInfo();
			}
			/**
			 * 是否添加层级关系
			 */
			if($parent){
				$parent_role = $amg->getRole($parent);
				try {
					$amg->addChild($parent_role, $role);
					$this->msg = "add {$parent_role->name}'s child [$name] success !";
					$this->outputInfo();
					$succ++;
				} catch (Exception $e) {
					$this->msg = "add {$parent_role->name}'s child [$name] error，maybe has existed !";
					$this->outputInfo();
				}
			}
		}
		$this->msg = "add role success count : [{$succ}]";
		$this->outputInfo();
	}
	
	public function outputInfo()
	{
		print_r("{$this->msg}\n");
	}
	
	/**
	 * 初始化adminUser的第一个用户为超级管理员
	 * @param ManagerInterface $amg
	 * @return bool
	 * @throws \Exception
	 */
	private function _addAssignment(ManagerInterface $amg)
	{
		$succ = $error = 0;
		$super_admin_id = AuthConfig::getSuperAdminId();
		if(empty($super_admin_id)){
			$this->msg = "there is no admin user in system !";
			$this->outputInfo();
			return false;
		}
		$super_role = $amg->getRole(AuthConfig::SUPER_ADMIN);
		$per = $amg->getPermissions();
		
		//给第一个用户添加超管角色
		$one = AuthAssignment::findOne(['item_name'=>AuthConfig::SUPER_ADMIN]);
		if($one){
			$this->msg = 'SuperAdmin has been set !';
			$this->outputInfo();
		}else{
			$r_assign = $amg->assign($super_role,$super_admin_id);
			$this->msg = $r_assign ? "set admin_user_id [{$super_admin_id}] as SuperAdmin} success !" : "set admin_user_id [{$super_admin_id}] as SuperAdmin} error !";
			$this->outputInfo();
		}
		
		//给超管角色分配所有权限
		foreach ($per as $item) {
			$r = $amg->addChild($super_role,$item);
			$r ? $succ++ : $error++;
		}
		$this->msg = "Set all permissions for super administrators success count : [{$succ}]";
		$this->outputInfo();
		$this->msg = "Set all permissions for super administrators error count : [{$error}]";
		$this->outputInfo();
	}
	
}